
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Kubernetes The Hard Way</title>
  <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../elements/codelab.html">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <style is="custom-style">
    body {
      font-family: "Roboto",sans-serif;
      background: var(--google-codelab-background, #F8F9FA);
    }
  </style>
  
</head>
<body unresolved class="fullbleed">

  <google-codelab title="Kubernetes The Hard Way"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="ã¾ãšæœ€åˆã«" duration="0">
        <p>å…ƒãƒã‚¿ã¯ä¸‹è¨˜ã§ã™ã€‚</p>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way" target="_blank">https://github.com/kelseyhightower/kubernetes-the-hard-way</a></p>
<p>ç¿»è¨³ã—ã¤ã¤ã€ã„ã‚ã„ã‚ãªãƒã‚¿ã‚’ã¯ã•ã‚“ã§ç´¹ä»‹ã§ãã‚Œã°ã¨æ€ã„ã¾ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="01. Introduction" duration="0">
        <p>Kubernetes Hard Wayã§ã¯ã€Kubernetesã®è¨­å®šã‚’ä¸€ã‹ã‚‰é€²ã‚ã¾ã™ã€‚</p>
<p>ãªã®ã§ã€ã“ã®ãƒ©ãƒœã¯ã€å®Œå…¨ã«è‡ªå‹•åŒ–ã•ã‚Œã¦ç®¡ç†ã•ã‚ŒãŸKubernetesã‚¯ãƒ©ã‚¹ã‚¿ä½œã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’æ¢ã—ã¦ã„ã‚‹äººã®ãŸã‚ã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>ã“ã®Kubernetes The Hard Wayã¯å­¦ç¿’ã™ã‚‹ã“ã¨ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ç«‹ã¡ä¸Šã’ã‚‹ãŸã‚ã®å¿…è¦ãªå„ã‚¿ã‚¹ã‚¯ã‚’ç¢ºå®Ÿã«ç†è§£ã™ã‚‹ãŸã‚ã®ã€é•·ã„é“ã®ã‚ŠãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<h2>æƒ³å®šèª­è€…</h2>
<p>æœ¬ç•ªç”¨ã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã‚’è¨ˆç”»ã—ã¦ã„ã¦ã€ã‹ã¤ã€Kubenretesã‚¯ãƒ©ã‚¹ã‚¿ã®ã™ã¹ã¦ã®éƒ¨å“ãŒã©ã®ã‚ˆã†ã«çµ„ã¿åˆã‚ã•ã£ã¦ã„ã‚‹ã‹ã‚’ç†è§£ã—ãŸã„ã¨ã„ã†äººå‘ã‘ã§ã™ã€‚</p>
<h2>ä»Šå›å‡ºæ¥ä¸ŠãŒã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ã®è©³ç´°</h2>
<p>Kubernetes The Hard Wayã§ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®æš—å·åŒ–ã¨RBACèªè¨¼ãŒã§ãã‚‹ã€å¯ç”¨æ€§ã®é«˜ã„Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<p>ä½¿ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes" target="_blank">Kubernetes</a> 1.12.0</li>
<li><a href="https://github.com/containerd/containerd" target="_blank">containerd Container Runtime</a> 1.2.0-rc.0</li>
<li><a href="https://github.com/google/gvisor" target="_blank">gVisor</a> 50c283b9f56bb7200938d9e207355f05f79f0d17</li>
<li><a href="https://github.com/containernetworking/cni" target="_blank">CNI Container Networking</a> 0.6.0</li>
<li><a href="https://github.com/coreos/etcd" target="_blank">etcd</a> v3.3.9</li>
<li><a href="https://github.com/coredns/coredns" target="_blank">CoreDNS</a> v1.2.2</li>
</ul>
<p>ã“ã®ãƒ©ãƒœã§ã¯ã€Google Cloud Platformã‚’ä½¿ã†ã“ã¨ã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚</p>
<p>GCPã¯ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ™ãƒ¼ã‚¹ã§ä½¿ã„ã¾ã™ãŒã€ã“ã®ãƒ©ãƒœã§å­¦ã‚“ã å†…å®¹ã¯ä»–ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚‚é©ç”¨ã§ãã¾ã™ã€‚</p>
<p>ã§ã¯ã€ã¯ã˜ã‚ã¦ã„ãã¾ã—ã‚‡ã†ï¼</p>


      </google-codelab-step>
    
      <google-codelab-step label="02. æº–å‚™" duration="0">
        <p>ä»Šå›ã¯GCPã‚’ä½¿ã†ã®ã§ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
<p>åˆå›ã«ã¯$300ã®ç„¡æ–™æ ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>å¤§ä½“ã®ã‚³ã‚¹ãƒˆã¯$0.22 / hour ($5.39 / day)ãã‚‰ã„ã§ã™ã€‚</p>
<h2>Google Cloud Platform SDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
<p>ã“ã®<a href="https://cloud.google.com/sdk/" target="_blank">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a> ã‚’å‚è€ƒã«<code>gcloud</code>ã‚³ãƒãƒ³ãƒ‰ã®æº–å‚™ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
<p>æœ€åˆã« <code>gcloud</code> ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†å ´åˆã¯ <code>init ã‚’ä½¿ã†ã®ãŒä¸€ç•ªæ‰‹ã£å–ã‚Šæ—©ã„ã§ã™ã€‚</code></p>
<pre>% gcloud init</pre>
<p>ã‚‚ã—ãã¯ã€è‡ªå‰ã§GCEã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®šã—ã¦ã„ãã¾ã—ã‚‡ã†</p>
<pre>% gcloud config set compute/region us-west1
% gcloud config set compute/zone us-west1-c</pre>
<p>ã¡ãªã¿ã«è‡ªåˆ†ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã«å½±éŸ¿ã‚ã‚Šãã†ãªã®ã§ã€è¨­å®šã›ãšã«ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦å©ãã‚ˆã†ã«ã—ã¾ã—ãŸã€‚</p>
<h2>tmuxã‚’ä½¿ã£ã¦ãƒ‘ãƒ©ãƒ¬ãƒ«ã«ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¦ã‚‹ã‚ˆã†ã«ã™ã‚‹</h2>
<p>ä¸€å¿œãŠã™ã™ã‚è¨­å®šã¨ã—ã¦æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§èˆˆå‘³ãŒã‚ã‚‹äººã¯ä¸‹è¨˜ã‚’è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/01-prerequisites.md#running-commands-in-parallel-with-tmux" target="_blank">https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/01-prerequisites.md#running-commands-in-parallel-with-tmux</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="03. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" duration="0">
        <h2>CFSSL</h2>
<p><code>cfssl</code> ã¨ <code>cfssljson</code> ã¯<a href="https://en.wikipedia.org/wiki/Public_key_infrastructure" target="_blank">PKIã®ç’°å¢ƒæ§‹ç¯‰</a>ã¨TLSã®è¨¼æ˜æ›¸ç™ºè¡Œã«ä½¿ã„ã¾ã™ã€‚</p>
<h3>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
<p>Linuxã®æ‰‹é †ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯Macã®ã¿è¨˜è¼‰ã—ã¾ã™ã€‚</p>
<pre>brew install cfssl</pre>
<p>Linuxã®æ‰‹é †ã¯ã“ã¡ã‚‰ã‹ã‚‰</p>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/02-client-tools.md#linux" target="_blank">https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/02-client-tools.md#linux</a></p>
<p><code>cfssl</code> ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ1.2.0ä»¥ä¸Šã‹ã©ã†ã‹ç¢ºèªã—ã¦ãã ã•ã„</p>
<pre># æ‰‹å…ƒã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
% cfssl version
Version: 1.3.2
Revision: dev
Runtime: go1.10</pre>
<h2>kubectlã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h2>
<p><code>kubectl</code> ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯1.12.0ä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚</p>
<p>brewçµŒç”±ã§ã‚‚gcloudçµŒç”±ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ã€‚</p>
<p>ä»Šå›ã¯gcloudã‚³ãƒãƒ³ãƒ‰çµŒç”±ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ <code>kubectl.1.12</code> ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ãŠã†ã¨æ€ã„ã¾ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="åˆ©ç”¨ã™ã‚‹GCPãƒªã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°" duration="0">
        <p>ã“ã“ã‹ã‚‰Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚</p>
<p>Kubernetesã«ã¯ã€Kubernetesã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚’å‹•ã‹ããƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒã‚·ãƒ³ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚</p>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€å˜ä¸€ã®<a href="https://cloud.google.com/compute/docs/regions-zones/regions-zones" target="_blank">ã‚¾ãƒ¼ãƒ³</a>ã§ã‚»ã‚­ãƒ¥ã‚¢ã‹ã¤å¯ç”¨æ€§ã®é«˜ã„Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’å‹•ã‹ã™ãŸã‚ã«å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚</p>
<h2>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</h2>
<p><a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/#kubernetes-model" target="_blank">Kubernetesã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ‡ãƒ«</a>ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã¨ãƒãƒ¼ãƒ‰ãŒäº’ã„ã«é€šä¿¡ã§ãã‚‹ãƒ•ãƒ©ãƒƒãƒˆãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚</p>
<p>ã“ã®ãƒãƒªã‚·ãƒ¼ã«æ²¿ãˆãªã„å ´åˆã¯ã€Kubernetesã®<a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" target="_blank">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼</a>ã‚’ä½¿ã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠç¾¤ãŒãŠäº’ã„ã«é€šä¿¡ã—ãŸã‚Šã€å¤–éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨é€šä¿¡ã™ã‚‹æ–¹æ³•ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚</p>
<aside class="warning"><p>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã®æ§‹ç¯‰ã¯ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯æ‰±ã„ã¾ã›ã‚“</p>
</aside>
<h3>Virtual Private Cloud Network</h3>
<p>Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹<a href="https://cloud.google.com/compute/docs/networks-and-firewalls#networks" target="_blank">VPC</a>ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
<p><code>ã¾ãšã¯ kubernetes-</code>the-hard-way ã¨ã„ã†åå‰ã§VPCã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>gcloud compute networks create kubernetes-the-hard-way --subnet-mode custom</pre>
<p>VPCã®<a href="https://cloud.google.com/compute/docs/vpc/#vpc_networks_and_subnets" target="_blank">ã‚µãƒ–ãƒãƒƒãƒˆ</a>ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®å„ãƒãƒ¼ãƒ‰ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚ŠæŒ¯ã‚‹ã®ã«ååˆ†ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã‚’ç¢ºä¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<pre>gcloud compute networks subnets create kubernetes \
  --network kubernetes-the-hard-way \
  --range 10.240.0.0/24</pre>
<aside class="special"><p>ã¡ãªã¿ã«10.240.0.0/24 ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã ã¨254å€‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚Œã¾ã™</p>
</aside>
<h3>Firewall Rules</h3>
<p>å…¨ã¦ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å†…éƒ¨é€šä¿¡ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«Firewallã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
<pre>gcloud compute firewall-rules create kubernetes-the-hard-way-allow-internal \
  --allow tcp,udp,icmp \
  --network kubernetes-the-hard-way \
  --source-ranges 10.240.0.0/24,10.200.0.0/16</pre>
<p>ã•ã‚‰ã«ã€å¤–éƒ¨ã‹ã‚‰ã®SSHã€ICMPã€HTTPSã‚‚è¨±å¯ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™</p>
<pre>gcloud compute firewall-rules create kubernetes-the-hard-way-allow-external \
  --allow tcp:22,tcp:6443,icmp \
  --network kubernetes-the-hard-way \
  --source-ranges 0.0.0.0/0</pre>
<aside class="special"><p>å¤–éƒ¨å‘ã‘ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã¯Kubernetesã®API ã‚µãƒ¼ãƒãƒ¼ã‚’å¤–éƒ¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å©ããŸã‚ã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚</p>
</aside>
<p>çµ‚ã‚ã£ãŸã‚‰ <code>kubernetes-the-hard-way</code> VPCã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre>gcloud compute firewall-rules list --filter=&#34;network:kubernetes-the-hard-way&#34;</pre>
<p>ä¾‹</p>
<pre>NAME                                    NETWORK                  DIRECTION  PRIORITY  ALLOW                 DENY
kubernetes-the-hard-way-allow-external  kubernetes-the-hard-way  INGRESS    1000      tcp:22,tcp:6443,icmp
kubernetes-the-hard-way-allow-internal  kubernetes-the-hard-way  INGRESS    1000      tcp,udp,icmp</pre>
<h3>Kubernetes Public IP Address</h3>
<p>Kubernetesã®APIã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã®å¤–éƒ¨LBã«ä»˜ä¸ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‰•ã„å‡ºã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre>gcloud compute addresses create kubernetes-the-hard-way \
  --region $(gcloud config get-value compute/region)</pre>
<p>çµ‚ã‚ã£ãŸã‚‰ç¢ºèªã—ã¦è¦‹ã¾ã—ã‚‡ã†</p>
<pre>gcloud compute addresses list --filter=&#34;name=(&#39;kubernetes-the-hard-way&#39;)&#34;</pre>
<p><code>ä¾‹</code></p>
<pre>NAME                     REGION    ADDRESS        STATUS
kubernetes-the-hard-way  us-west1  XX.XXX.XXX.XX  RESERVED</pre>
<h2>GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</h2>
<p>ã“ã®ãƒ©ãƒœã®GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€<a href="https://github.com/containerd/containerd" target="_blank">containerdã®ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ </a>ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹<a href="https://www.ubuntu.com/server" target="_blank">Ubuntu Server</a> 18.04ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚</p>
<p>å„GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€Kubernetesã®ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã«å›ºå®šã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚ŠæŒ¯ã‚Šã¾ã™ã€‚</p>
<h3>Kubernetes Controllers</h3>
<p>Kunernetesã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’å¸ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’3ã¤ç«‹ã¦ã¾ã™ã€‚</p>
<pre>for i in 0 1 2; do
  gcloud compute instances create controller-${i} \
    --async \
    --boot-disk-size 200GB \
    --can-ip-forward \
    --image-family ubuntu-1804-lts \
    --image-project ubuntu-os-cloud \
    --machine-type n1-standard-1 \
    --private-network-ip 10.240.0.1${i} \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet kubernetes \
    --tags kubernetes-the-hard-way,controller
done</pre>
<h3>Kubernetes Workers</h3>
<p>å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®CIDRç¯„å›²ã‹ã‚‰Podã«å¯¾ã™ã‚‹ã‚µãƒ–ãƒãƒƒãƒˆã®å‰²ã‚Šå½“ã¦ãŒå¿…è¦ã§ã™ã€‚</p>
<p>Podã®ã‚µãƒ–ãƒãƒƒãƒˆã®å‰²ã‚Šå½“ã¦ã¯ã€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚³ãƒ³ãƒ†ãƒŠãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚</p>
<p><code>pod-cidr</code> ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ã€å®Ÿè¡Œæ™‚ã«Podã®ã‚µãƒ–ãƒãƒƒãƒˆå‰²ã‚Šå½“ã¦ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨å…±æœ‰ã™ã‚‹ãŸã‚(å…¬é–‹ï¼Ÿ)ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
<aside class="special"><p>Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®CIDRç¯„å›²ã¯ã€Controller Managerã® <code>--cluster-cidr</code> flagã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¾ã™ã€‚</p>
<p>ä»Šå›ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿CIDRç¯„å›²ã¯ <code>10.200.0.0/16</code> ã«è¨­å®šã•ã‚Œã€254å€‹ã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
</aside>
<p>Kubernetesã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã¨ã—ã¦3ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>for i in 0 1 2; do
  gcloud compute instances create worker-${i} \
    --async \
    --boot-disk-size 200GB \
    --can-ip-forward \
    --image-family ubuntu-1804-lts \
    --image-project ubuntu-os-cloud \
    --machine-type n1-standard-1 \
    --metadata pod-cidr=10.200.${i}.0/24 \
    --private-network-ip 10.240.0.2${i} \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet kubernetes \
    --tags kubernetes-the-hard-way,worker
done</pre>
<p>çµ‚ã‚ã£ãŸã‚‰ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre>gcloud compute instances list</pre>
<p>ä¾‹</p>
<pre>NAME          ZONE        MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP     STATUS
controller-0  us-west1-c  n1-standard-1               10.240.0.10  XX.XXX.XXX.XXX  RUNNING
controller-1  us-west1-c  n1-standard-1               10.240.0.11  XX.XXX.X.XX     RUNNING
controller-2  us-west1-c  n1-standard-1               10.240.0.12  XX.XXX.XXX.XX   RUNNING
worker-0      us-west1-c  n1-standard-1               10.240.0.20  XXX.XXX.XXX.XX  RUNNING
worker-1      us-west1-c  n1-standard-1               10.240.0.21  XX.XXX.XX.XXX   RUNNING
worker-2      us-west1-c  n1-standard-1               10.240.0.22  XXX.XXX.XX.XX   RUNNING</pre>
<h2>Configuring SSH Access</h2>
<p>SSHçµŒç”±ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<p>åˆã‚ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶šã™ã‚‹ã¨ãã«ã€<a href="https://cloud.google.com/compute/docs/instances/connecting-to-instance" target="_blank">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®æ¥ç¶š</a>ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹é€šã‚Šã€SSHã‚­ãƒ¼ãŒè‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
<p>è©¦ã—ã« <code>controller-0</code> ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre>gcloud compute ssh controller-0</pre>
<p>åˆå›ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«SSHã®éµãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</p>
<p>ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµŒç”±ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
<pre>WARNING: The public SSH key file for gcloud does not exist.
WARNING: The private SSH key file for gcloud does not exist.
WARNING: You do not have an SSH key for gcloud.
WARNING: SSH keygen will be executed to generate a key.
Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:</pre>
<p>ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§SSHã®éµãŒç”Ÿæˆã•ã‚Œã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
<pre>Your identification has been saved in /home/$USER/.ssh/google_compute_engine.
Your public key has been saved in /home/$USER/.ssh/google_compute_engine.pub.
The key fingerprint is:
SHA256:nz1i8jHmgQuGt+WscqP5SeIaSy5wyIJeL71MuV+QruE $USER@$HOSTNAME
The key&#39;s randomart image is:
+---[RSA 2048]----+
|                 |
|                 |
|                 |
|        .        |
|o.     oS        |
|=... .o .o o     |
|+.+ =+=.+.X o    |
|.+ ==O*B.B = .   |
| .+.=EB++ o      |
+----[SHA256]-----+
Updating project ssh metadata...-Updated [https://www.googleapis.com/compute/v1/projects/$PROJECT_ID].
Updating project ssh metadata...done.
Waiting for SSH key to propagate.</pre>
<p>SSHã®éµã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã™ã‚Œã°ã€<code>controller-0</code> ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å…¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<pre>Welcome to Ubuntu 18.04 LTS (GNU/Linux 4.15.0-1006-gcp x86_64)
...
Last login: Sun May 13 14:34:27 2018 from XX.XXX.XXX.XX</pre>
<p>ã“ã“ã¾ã§ã§ããŸã‚‰ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰exitã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="04. èªè¨¼å±€(CA)ã®è¨­å®šã¨TLSè¨¼æ˜æ›¸ã®ç™ºè¡Œ" duration="0">
        <p>ã“ã®ãƒ©ãƒœã§ã¯ã€CloudFlareã®PKIãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã§ã‚ã‚‹ <a href="https://github.com/cloudflare/cfssl" target="_blank">cfssl</a> ã‚’ä½¿ã£ã¦<a href="https://en.wikipedia.org/wiki/Public_key_infrastructure" target="_blank">PKIåŸºç›¤</a>ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚</p>
<p>ãã—ã¦ã€PKIåŸºç›¤ã‚’åˆ©ç”¨ã—ã¦èªè¨¼å±€ã‚’ä½œã‚Šã€etcdã€kube-apiserverã€kube-controller-managerã€kube-schedulerã€ kubeletã€kube-proxyã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®TLSè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<h2>è¨¼æ˜å±€(CA)</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€TLSè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®èªè¨¼å±€(CA)ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚</p>
<p>ã¾ãšã¯ã€CAè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€è¨¼æ˜æ›¸ã€ãŠã‚ˆã³ç§˜å¯†éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{

cat &gt; ca-config.json &lt;&lt;EOF
{
  &#34;signing&#34;: {
    &#34;default&#34;: {
      &#34;expiry&#34;: &#34;8760h&#34;
    },
    &#34;profiles&#34;: {
      &#34;kubernetes&#34;: {
        &#34;usages&#34;: [&#34;signing&#34;, &#34;key encipherment&#34;, &#34;server auth&#34;, &#34;client auth&#34;],
        &#34;expiry&#34;: &#34;8760h&#34;
      }
    }
  }
}
EOF

cat &gt; ca-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;Kubernetes&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;Kubernetes&#34;,
      &#34;OU&#34;: &#34;CA&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

cfssl gencert -initca ca-csr.json | cfssljson -bare ca

}</pre>
<p><code>ç”Ÿæˆç‰©</code></p>
<pre>ca-key.pem
ca.pem</pre>
<h2>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®è¨¼æ˜æ›¸ç™ºè¡Œ</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€å„Kubernetesã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ã†ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã¨ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã€Kubernetes <code>admin</code> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
<h3>Adminç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸</h3>
<p>ã¾ãšã¯ã€ <code>admin</code> ç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{

cat &gt; admin-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;admin&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;system:masters&#34;,
      &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  admin-csr.json | cfssljson -bare admin

}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>admin-key.pem
admin.pem</pre>
<h3>Kubeletã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸</h3>
<p>Kubernetesã¯ã€Node Authorizerã¨å‘¼ã°ã‚Œã‚‹<a href="https://kubernetes.io/docs/admin/authorization/node/" target="_blank">ç‰¹åˆ¥ãªç”¨é€”å‘ã‘ã®èªå¯ãƒ¢ãƒ¼ãƒ‰</a>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚</p>
<p>ã“ã‚Œã¯ç‰¹ã«<a href="https://kubernetes.io/docs/concepts/overview/components/#kubelet" target="_blank">Kubelet</a>ã‹ã‚‰ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚</p>
<p>Node Authorizerã®èªå¯ã®ãŸã‚ã«ã¯ã€Kubeletã¯ã€<code>system:nodes</code> groupã®ä¸­ã® <code>system:node:&lt;nodeName&gt;</code> ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§èªè¨¼ã•ã‚Œã‚‹ã‚ˆã†ã«è¨¼æ˜æ›¸ã‚’ä½œæˆã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚</p>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Kubernetesãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã”ã¨ã«Node Authorizerã®è¦æ±‚ã‚’æº€ãŸã™è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
<pre>for instance in worker-0 worker-1 worker-2; do
cat &gt; ${instance}-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;system:node:${instance}&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;system:nodes&#34;,
      &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

EXTERNAL_IP=$(gcloud compute instances describe ${instance} \
  --format &#39;value(networkInterfaces[0].accessConfigs[0].natIP)&#39;)

INTERNAL_IP=$(gcloud compute instances describe ${instance} \
  --format &#39;value(networkInterfaces[0].networkIP)&#39;)

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -hostname=${instance},${EXTERNAL_IP},${INTERNAL_IP} \
  -profile=kubernetes \
  ${instance}-csr.json | cfssljson -bare ${instance}
done</pre>
<p><code>ç”Ÿæˆç‰©</code></p>
<pre>worker-0-key.pem
worker-0.pem
worker-1-key.pem
worker-1.pem
worker-2-key.pem
worker-2.pem</pre>
<h3>kube-contorller-manager ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨¼æ˜æ›¸</h3>
<p><code>kube-controller-manager</code> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
<pre>{

cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;system:kube-controller-manager&#34;,
      &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager

}</pre>
<p><code>ç”Ÿæˆç‰©</code></p>
<pre>kube-controller-manager-key.pem
kube-controller-manager.pem</pre>
<h3>kube-proxy ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨¼æ˜æ›¸</h3>
<p><code>kube-proxy</code> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã«è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
<pre>{

cat &gt; kube-proxy-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;system:kube-proxy&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;system:node-proxier&#34;,
      &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kube-proxy-csr.json | cfssljson -bare kube-proxy

}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>kube-proxy-key.pem
kube-proxy.pem</pre>
<h3>kube-scheduler ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã®è¨¼æ˜æ›¸</h3>
<p><code>kube-scheduler</code> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã®è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
<pre>{

cat &gt; kube-scheduler-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;system:kube-scheduler&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;system:kube-scheduler&#34;,
      &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kube-scheduler-csr.json | cfssljson -bare kube-scheduler

}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>kube-scheduler-key.pem
kube-scheduler.pem</pre>
<h3>Kubernetes API ã‚µãƒ¼ãƒãƒ¼ç”¨è¨¼æ˜æ›¸</h3>
<p><code>kubernetes-the-hard-way</code> ã®static IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€Kubernetes API ã‚µãƒ¼ãƒãƒ¼ã®è¨¼æ˜æ›¸ã®SAN(ã‚µãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆ¥å)ã®ãƒªã‚¹ãƒˆã«å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ã“ã‚Œã«ã‚ˆã‚Šã€å¤–éƒ¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚è¨¼æ˜æ›¸ã‚’ä½¿ã£ãŸæ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚</p>
<p>Kubernetes API ã‚µãƒ¼ãƒãƒ¼ã®è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{

KUBERNETES_PUBLIC_ADDRESS=$(gcloud compute addresses describe kubernetes-the-hard-way \
  --region $(gcloud config get-value compute/region) \
  --format &#39;value(address)&#39;)

cat &gt; kubernetes-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;kubernetes&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;Kubernetes&#34;,
      &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -hostname=10.32.0.1,10.240.0.10,10.240.0.11,10.240.0.12,${KUBERNETES_PUBLIC_ADDRESS},127.0.0.1,kubernetes.default \
  -profile=kubernetes \
  kubernetes-csr.json | cfssljson -bare kubernetes

}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>kubernetes-key.pem
kubernetes.pem</pre>
<h3>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ãƒšã‚¢</h3>
<p><a href="https://kubernetes.io/docs/admin/service-accounts-admin/" target="_blank">ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>ã«ã‚ã‚‹ã‚ˆã†ã«ã€Kubernetes Controller Managerã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆã¨ç½²åã‚’ã™ã‚‹ãŸã‚ã«ã‚­ãƒ¼ãƒšã‚¢ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚</p>
<p><code>service-account</code> ã®è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
<pre>{

cat &gt; service-account-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;service-accounts&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;US&#34;,
      &#34;L&#34;: &#34;Portland&#34;,
      &#34;O&#34;: &#34;Kubernetes&#34;,
      &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
      &#34;ST&#34;: &#34;Oregon&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  service-account-csr.json | cfssljson -bare service-account

}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>service-account-key.pem
service-account.pem</pre>
<h2>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®è¨¼æ˜æ›¸ã®é…ç½®</h2>
<p>è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç½®ãã¾ã™ã€‚</p>
<pre>for instance in worker-0 worker-1 worker-2; do
  gcloud compute scp ca.pem ${instance}-key.pem ${instance}.pem ${instance}:~/
done</pre>
<p>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚‚è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚‚ç½®ãã¾ã™ã€‚</p>
<pre>for instance in controller-0 controller-1 controller-2; do
  gcloud compute scp ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \
    service-account-key.pem service-account.pem ${instance}:~/
done</pre>
<aside class="special"><p>kube-proxyã€kube-controller-managerã€kube-schedulerã€kubelet ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã§ä½¿ã„ã¾ã™ã€‚</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="05. èªè¨¼ç”¨ã®Kubernetesã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹" duration="0">
        <p>ãµãƒ¼ãƒ¼ãƒ¼ã€ã‚„ã£ã¨Kubernetesã½ããªã£ã¦ããŸã‹ãªã€ã€</p>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Kubernetes APIã‚µãƒ¼ãƒãƒ¼ãŒKubernetesã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èªè¨¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®<a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" target="_blank">kubeconfigs(Kubernetesæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«)</a>ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<h2>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èªè¨¼è¨­å®š</h2>
<p>ã¾ãšã¯ã€<code>conttoller-manager</code>ã€<code>kubelet</code>ã€<code>kube-proxy</code>ã€<code>scheduler</code>ã€ <code>admin</code> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®kubeconfigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<h3>Kubernetesã®Public IPã‚¢ãƒ‰ãƒ¬ã‚¹</h3>
<p>kubeconfigã¯ã€Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã¨æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚</p>
<p>é«˜å¯ç”¨æ€§ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã«ã‚ã‚‹å¤–éƒ¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«å‰²ã‚Šå½“ã¦ã‚‹ãŸã‚ã«ã“ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ã„ã¾ã™ã€‚</p>
<p><code>kubernetes-the-hard-way</code> ã®static IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¢ã—ã¦è¨­å®šã—ã¾ã™ã€‚</p>
<pre>KUBERNETES_PUBLIC_ADDRESS=$(gcloud compute addresses describe kubernetes-the-hard-way \
  --region $(gcloud config get-value compute/region) \
  --format &#39;value(address)&#39;)</pre>
<h3>kubeletã®kubeconfigsã®ç”Ÿæˆ</h3>
<p>kubeletç”¨ã®kubeconfigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã¨ãã¯ã€kubeletã®ãƒãƒ¼ãƒ‰åã¨åŒã˜ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ãã†ã™ã‚‹ã¨ã€kubeletãŒKubernetesã®<a href="https://kubernetes.io/docs/admin/authorization/node/" target="_blank">Node Authorizer</a>ã«ã‚ˆã£ã¦èªå¯ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰æ¯ã«kubeconfigã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>for instance in worker-0 worker-1 worker-2; do
  kubectl config set-cluster kubernetes-the-hard-way \
    --certificate-authority=ca.pem \
    --embed-certs=true \
    --server=https://${KUBERNETES_PUBLIC_ADDRESS}:6443 \
    --kubeconfig=${instance}.kubeconfig

  kubectl config set-credentials system:node:${instance} \
    --client-certificate=${instance}.pem \
    --client-key=${instance}-key.pem \
    --embed-certs=true \
    --kubeconfig=${instance}.kubeconfig

  kubectl config set-context default \
    --cluster=kubernetes-the-hard-way \
    --user=system:node:${instance} \
    --kubeconfig=${instance}.kubeconfig

  kubectl config use-context default --kubeconfig=${instance}.kubeconfig
done</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>worker-0.kubeconfig
worker-1.kubeconfig
worker-2.kubeconfig</pre>
<h3>kube-proxyã®kubeconfigã®ç”Ÿæˆ</h3>
<p><code>kube-proxy</code>ã®kubeconfigã‚‚ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{
  kubectl config set-cluster kubernetes-the-hard-way \
    --certificate-authority=ca.pem \
    --embed-certs=true \
    --server=https://${KUBERNETES_PUBLIC_ADDRESS}:6443 \
    --kubeconfig=kube-proxy.kubeconfig

  kubectl config set-credentials system:kube-proxy \
    --client-certificate=kube-proxy.pem \
    --client-key=kube-proxy-key.pem \
    --embed-certs=true \
    --kubeconfig=kube-proxy.kubeconfig

  kubectl config set-context default \
    --cluster=kubernetes-the-hard-way \
    --user=system:kube-proxy \
    --kubeconfig=kube-proxy.kubeconfig

  kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig
}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>kube-proxy.kubeconfig</pre>
<h3>kube-controller-managerã®kubeconfig</h3>
<p>ã“ã“ã¾ã§ãã‚‹ã¨ã€ã‚ã‹ã£ã¦ãã¾ã™ã­ã€‚</p>
<p><code>kube-controller-manager</code>ã®kubeconfigã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{
  kubectl config set-cluster kubernetes-the-hard-way \
    --certificate-authority=ca.pem \
    --embed-certs=true \
    --server=https://127.0.0.1:6443 \
    --kubeconfig=kube-controller-manager.kubeconfig

  kubectl config set-credentials system:kube-controller-manager \
    --client-certificate=kube-controller-manager.pem \
    --client-key=kube-controller-manager-key.pem \
    --embed-certs=true \
    --kubeconfig=kube-controller-manager.kubeconfig

  kubectl config set-context default \
    --cluster=kubernetes-the-hard-way \
    --user=system:kube-controller-manager \
    --kubeconfig=kube-controller-manager.kubeconfig

  kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig
}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>kube-controller-manager.kubeconfig</pre>
<h3>kube-schedulerã®kubeconfig</h3>
<p><code>kube-scheduler</code>ã®kubeconfigã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{
  kubectl config set-cluster kubernetes-the-hard-way \
    --certificate-authority=ca.pem \
    --embed-certs=true \
    --server=https://127.0.0.1:6443 \
    --kubeconfig=kube-scheduler.kubeconfig

  kubectl config set-credentials system:kube-scheduler \
    --client-certificate=kube-scheduler.pem \
    --client-key=kube-scheduler-key.pem \
    --embed-certs=true \
    --kubeconfig=kube-scheduler.kubeconfig

  kubectl config set-context default \
    --cluster=kubernetes-the-hard-way \
    --user=system:kube-scheduler \
    --kubeconfig=kube-scheduler.kubeconfig

  kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig
}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>kube-scheduler.kubeconfig</pre>
<h3>adminãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®kubeconfig</h3>
<p><code>admin</code>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®kubeconfigã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{
  kubectl config set-cluster kubernetes-the-hard-way \
    --certificate-authority=ca.pem \
    --embed-certs=true \
    --server=https://127.0.0.1:6443 \
    --kubeconfig=admin.kubeconfig

  kubectl config set-credentials admin \
    --client-certificate=admin.pem \
    --client-key=admin-key.pem \
    --embed-certs=true \
    --kubeconfig=admin.kubeconfig

  kubectl config set-context default \
    --cluster=kubernetes-the-hard-way \
    --user=admin \
    --kubeconfig=admin.kubeconfig

  kubectl config use-context default --kubeconfig=admin.kubeconfig
}</pre>
<p>ç”Ÿæˆç‰©</p>
<pre>admin.kubeconfig</pre>
<h3>kubeconfigã®é…å¸ƒ</h3>
<p><code>kubelet</code>ã¨<code>kube-proxy</code>ã®kubecnofigã¯å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™</p>
<pre>for instance in worker-0 worker-1 worker-2; do
  gcloud compute scp ${instance}.kubeconfig kube-proxy.kubeconfig ${instance}:~/
done</pre>
<p><code>kube-controller-manager</code>ã¨<code>kube-scheduler</code>ã®kubeconfigã¯å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚</p>
<pre>for instance in controller-0 controller-1 controller-2; do
  gcloud compute scp admin.kubeconfig kube-controller-manager.kubeconfig kube-scheduler.kubeconfig ${instance}:~/
done</pre>


      </google-codelab-step>
    
      <google-codelab-step label="06. ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ç”¨ã®è¨­å®šã¨æš—å·åŒ–éµã®ç”Ÿæˆ" duration="0">
        <p>Kubernetesã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ã®çŠ¶æ…‹ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã€ç§˜åŒ¿æƒ…å ±ãªã©ã‚’å«ã‚€ã•ã¾ã–ã¾ãªãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚</p>
<p>Kubernetesã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã§ä¿æŒã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’<a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data" target="_blank">æš—å·åŒ–</a>ã™ã‚‹æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Kubernetes Secretsã®æš—å·åŒ–ã«åˆã‚ã›ãŸæš—å·åŒ–éµã¨<a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#understanding-the-encryption-at-rest-configuration" target="_blank">æš—å·åŒ–ã®è¨­å®š</a>ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<h2>æš—å·åŒ–éµ</h2>
<p>æš—å·åŒ–éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</pre>
<h2>æš—å·åŒ–ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</h2>
<p>æš—å·åŒ–ã®è¨­å®šã®ãŸã‚ã®<code>encryption-config.yaml</code>ã‚’ç”Ÿæˆã—ã¾ã™ã€‚(ã‚„ã£ã¨kubenretesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãŒã§ã¦ããŸã‚“ã˜ã‚ƒãªã„ã‹ï¼Ÿ)</p>
<pre>cat &gt; encryption-config.yaml &lt;&lt;EOF
kind: EncryptionConfig
apiVersion: v1
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: key1
              secret: ${ENCRYPTION_KEY}
      - identity: {}
EOF</pre>
<p>ã“ã®<code>encryption-config.yaml</code>ã‚’å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚</p>
<pre>for instance in controller-0 controller-1 controller-2; do
  gcloud compute scp encryption-config.yaml ${instance}:~/
done</pre>


      </google-codelab-step>
    
      <google-codelab-step label="07. etcdã‚¯ãƒ©ã‚¹ã‚¿ã®èµ·å‹•" duration="0">
        <p>Kubernetesã®å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã«ãªã£ã¦ãŠã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿ã®çŠ¶æ…‹<a href="https://github.com/coreos/etcd" target="_blank">etcd</a>ã«æ ¼ç´ã•ã‚Œç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚(ã¤ã¾ã‚ŠetcdãŒè¶…é‡è¦)</p>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€3ãƒãƒ¼ãƒ‰ã®etcdã‚¯ãƒ©ã‚¹ã‚¿ã‚’æ§‹ç¯‰ã—ã¦ã€é«˜å¯ç”¨æ€§ã¨å®‰å…¨ãªå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œã—ã¾ã™ã€‚</p>
<h2>æº–å‚™</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€<code>controller-0</code>ã€<code>controller-1</code>ã€<code>controller-2</code>ã®å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>gcloudã‚³ãƒãƒ³ãƒ‰çµŒç”±ã§å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
<pre>gcloud compute ssh controller-0</pre>
<h3>tmuxã‚’ä½¿ã£ã¦ä¸¦åˆ—ã«ã‚³ãƒãƒ³ãƒ‰ã‚’èµ°ã‚‰ã›ã‚‹</h3>
<p>tmuxã‚’ä½¿ãˆã°ã€åŒæ™‚ã«è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒã§ãã¾ã™ã€‚</p>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/01-prerequisites.md#running-commands-in-parallel-with-tmux" target="_blank">ã“ã£ã¡</a>ã‚’ã¿ã¦ã¿ã¦ã­ã€‚</p>
<h2>etcdã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¡ãƒ³ãƒãƒ¼ã®èµ·å‹•</h2>
<p>ã“ã“ã‹ã‚‰ã®æ‰‹é †ã¯å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§è¡Œã„ã¾ã™ã€‚</p>
<h3>etcdã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
<p>etcdã®ãƒã‚¤ãƒŠãƒªã‚’githubã‹ã‚‰DLã—ã¾ã™ã€‚</p>
<pre>wget -q --show-progress --https-only --timestamping \
  &#34;https://github.com/coreos/etcd/releases/download/v3.3.9/etcd-v3.3.9-linux-amd64.tar.gz&#34;</pre>
<p>DLã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ã—ã¦<code>etcd</code>ã‚µãƒ¼ãƒãƒ¼ã¨ <code>etcdctl</code>ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚</p>
<pre>{
  tar -xvf etcd-v3.3.9-linux-amd64.tar.gz
  sudo mv etcd-v3.3.9-linux-amd64/etcd* /usr/local/bin/
}</pre>
<h3>etcdã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š</h3>
<pre>{
  sudo mkdir -p /etc/etcd /var/lib/etcd
  sudo cp ca.pem kubernetes-key.pem kubernetes.pem /etc/etcd/
}</pre>
<p>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†…éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦ã€etcdã‚¯ãƒ©ã‚¹ã‚¿é–“ã§é€šä¿¡ã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚</p>
<p>ç¾åœ¨ã®GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†…éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>INTERNAL_IP=$(curl -s -H &#34;Metadata-Flavor: Google&#34; \
  http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip)</pre>
<p>å„etcdã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ã€etcdã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§åå‰ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ç¾åœ¨ã®GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ›ã‚¹ãƒˆåã§etcdã®åå‰ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<pre>ETCD_NAME=$(hostname -s)</pre>
<p><code>etcd.service</code>ã¨ã—ã¦systemdã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/etcd.service
[Unit]
Description=etcd
Documentation=https://github.com/coreos

[Service]
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NAME} \\
  --cert-file=/etc/etcd/kubernetes.pem \\
  --key-file=/etc/etcd/kubernetes-key.pem \\
  --peer-cert-file=/etc/etcd/kubernetes.pem \\
  --peer-key-file=/etc/etcd/kubernetes-key.pem \\
  --trusted-ca-file=/etc/etcd/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${INTERNAL_IP}:2380 \\
  --listen-peer-urls https://${INTERNAL_IP}:2380 \\
  --listen-client-urls https://${INTERNAL_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${INTERNAL_IP}:2379 \\
  --initial-cluster-token etcd-cluster-0 \\
  --initial-cluster controller-0=https://10.240.0.10:2380,controller-1=https://10.240.0.11:2380,controller-2=https://10.240.0.12:2380 \\
  --initial-cluster-state new \\
  --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</pre>
<h3>etcdã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•</h3>
<pre>{
  sudo systemctl daemon-reload
  sudo systemctl enable etcd
  sudo systemctl start etcd
}</pre>
<aside class="special"><p>å¿µæŠ¼ã—ã§ã™ãŒã€ã“ã“ã¾ã§ã®ã“ã¨ã‚’ã€å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ <code>controller-0</code>ã€<code>controller-1</code>ã€<code>controller-2</code>ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼</p>
</aside>
<h2>ç¢ºèª</h2>
<p>etcdã®ã‚¯ãƒ©ã‚¹ã‚¿ã®ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚</p>
<pre>sudo ETCDCTL_API=3 etcdctl member list \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/etcd/ca.pem \
  --cert=/etc/etcd/kubernetes.pem \
  --key=/etc/etcd/kubernetes-key.pem</pre>
<p>ä¾‹</p>
<pre>3a57933972cb5131, started, controller-2, https://10.240.0.12:2380, https://10.240.0.12:2379
f98dc20bce6225a0, started, controller-0, https://10.240.0.10:2380, https://10.240.0.10:2379
ffed16798470cab5, started, controller-1, https://10.240.0.11:2380, https://10.240.0.11:2379</pre>


      </google-codelab-step>
    
      <google-codelab-step label="08. Kubernetesã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—" duration="0">
        <p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€3ã¤ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã£ã¦å¯ç”¨æ€§ã®é«˜ã„Kubernetesã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<p>åˆã‚ã›ã¦ã€Kubernetes API Serverã‚’å¤–éƒ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å…¬é–‹ã™ã‚‹å¤–éƒ¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚‚ä½œæˆã—ã¾ã™ã€‚</p>
<p>å„ãƒãƒ¼ãƒ‰ã«ã€Kubernetes API Serverã€Schedulerã€ãŠã‚ˆã³Controller Managerã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>
<h2>æº–å‚™</h2>
<p>å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨åŒã˜ãã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚‚ã€<code>controller-0</code>ã€<code>controller-1</code>ã€<code>controller-2</code>ã®å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>gcloudã‚³ãƒãƒ³ãƒ‰çµŒç”±ã§å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
<pre>gcloud compute ssh controller-0</pre>
<h3>tmuxã‚’ä½¿ã£ã¦ä¸¦åˆ—ã«ã‚³ãƒãƒ³ãƒ‰ã‚’èµ°ã‚‰ã›ã‚‹</h3>
<p>tmuxã‚’ä½¿ãˆã°ã€åŒæ™‚ã«è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒã§ãã¾ã™ã€‚</p>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/01-prerequisites.md#running-commands-in-parallel-with-tmux" target="_blank">ã“ã£ã¡</a>ã‚’ã¿ã¦ã¿ã¦ã­ã€‚</p>
<h2>Kubernetesã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°</h2>
<p>Kubernetesã®è¨­å®šã‚’ãŠããƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<pre>sudo mkdir -p /etc/kubernetes/config</pre>
<h3>Kubernetesã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒã‚¤ãƒŠãƒªã®DLã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
<p>Kubernetesã®å…¬å¼ã®ãƒªãƒªãƒ¼ã‚¹ãƒã‚¤ãƒŠãƒªã‚’DLã—ã¾ã™</p>
<pre>wget -q --show-progress --https-only --timestamping \
  &#34;https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kube-apiserver&#34; \
  &#34;https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kube-controller-manager&#34; \
  &#34;https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kube-scheduler&#34; \
  &#34;https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kubectl&#34;</pre>
<p>DLã—ãŸãƒã‚¤ãƒŠãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>
<pre>{
  chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl
  sudo mv kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/
}</pre>
<h3>KubernetesAPIã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š</h3>
<pre>{
  sudo mkdir -p /var/lib/kubernetes/

  sudo mv ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \
    service-account-key.pem service-account.pem \
    encryption-config.yaml /var/lib/kubernetes/
}</pre>
<p>APIã‚µãƒ¼ãƒãƒ¼ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ãƒ¡ãƒ³ãƒãƒ¼ã«çŸ¥ã‚‰ã›ã‚‹ãŸã‚ã®è¨­å®šã¨ã—ã¦ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†…éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ã„ã¾ã™ã€‚</p>
<p>ç¾åœ¨ã®GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†…éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>INTERNAL_IP=$(curl -s -H &#34;Metadata-Flavor: Google&#34; \
  http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip)</pre>
<p><code>kube-apiserver.service</code>ã®systemdã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
  --advertise-address=${INTERNAL_IP} \\
  --allow-privileged=true \\
  --apiserver-count=3 \\
  --audit-log-maxage=30 \\
  --audit-log-maxbackup=3 \\
  --audit-log-maxsize=100 \\
  --audit-log-path=/var/log/audit.log \\
  --authorization-mode=Node,RBAC \\
  --bind-address=0.0.0.0 \\
  --client-ca-file=/var/lib/kubernetes/ca.pem \\
  --enable-admission-plugins=Initializers,NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\
  --enable-swagger-ui=true \\
  --etcd-cafile=/var/lib/kubernetes/ca.pem \\
  --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\
  --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\
  --etcd-servers=https://10.240.0.10:2379,https://10.240.0.11:2379,https://10.240.0.12:2379 \\
  --event-ttl=1h \\
  --experimental-encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\
  --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\
  --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\
  --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\
  --kubelet-https=true \\
  --runtime-config=api/all \\
  --service-account-key-file=/var/lib/kubernetes/service-account.pem \\
  --service-cluster-ip-range=10.32.0.0/24 \\
  --service-node-port-range=30000-32767 \\
  --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\
  --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</pre>
<p>å‚è€ƒ : <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/" target="_blank">https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/</a></p>
<h3>Kubernetesã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®è¨­å®š</h3>
<p><code>kube-controller-manager</code>ã®kubeconfigã‚’ç§»å‹•ã•ã›ã¾ã™ã€‚</p>
<pre>sudo mv kube-controller-manager.kubeconfig /var/lib/kubernetes/</pre>
<p><code>kube-controller-manager.service</code>ã®systemdãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \\
  --address=0.0.0.0 \\
  --cluster-cidr=10.200.0.0/16 \\
  --cluster-name=kubernetes \\
  --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem \\
  --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem \\
  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\
  --leader-elect=true \\
  --root-ca-file=/var/lib/kubernetes/ca.pem \\
  --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem \\
  --service-cluster-ip-range=10.32.0.0/24 \\
  --use-service-account-credentials=true \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</pre>
<h3>Kubernetesã®schedulerã®è¨­å®š</h3>
<p><code>kube-scheduler</code>ã®kubeconfigã‚’ç§»å‹•ã•ã›ã¾ã™ã€‚</p>
<pre>sudo mv kube-scheduler.kubeconfig /var/lib/kubernetes/</pre>
<p><code>kube-scheduler.yaml</code>ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/kubernetes/config/kube-scheduler.yaml
apiVersion: componentconfig/v1alpha1
kind: KubeSchedulerConfiguration
clientConnection:
  kubeconfig: &#34;/var/lib/kubernetes/kube-scheduler.kubeconfig&#34;
leaderElection:
  leaderElect: true
EOF</pre>
<p><code>kube-scheduler.service</code>ã®systemdãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-scheduler.service
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-scheduler \\
  --config=/etc/kubernetes/config/kube-scheduler.yaml \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</pre>
<p>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã®èµ·å‹•</p>
<pre>{
  sudo systemctl daemon-reload
  sudo systemctl enable kube-apiserver kube-controller-manager kube-scheduler
  sudo systemctl start kube-apiserver kube-controller-manager kube-scheduler
}</pre>
<aside class="special"><p>Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã¯åˆæœŸåŒ–ãŒå®Œäº†ã™ã‚‹ã¾ã§10ç§’ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã€‚</p>
</aside>
<h3>HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹</h3>
<p><a href="https://cloud.google.com/compute/docs/load-balancing/network" target="_blank">GCLB</a>ã‚’ä½¿ã£ã¦3ã¤ã®KubernetesAPIã‚µãƒ¼ãƒãƒ¼ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’åˆ†æ•£ã•ã›ã€TSLæ¥ç¶šã‚’ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
<p>GCLBã¯HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã¿ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€APIã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹HTTPSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã¤ã‹ãˆã¾ã›ã‚“ã€‚</p>
<p>å›é¿ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€nginx Webã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã‚Šã‚¯ã‚¹ã‚¨ã‚¹ãƒˆã‚’ãƒ—ãƒ­ã‚­ã‚·ã•ã›ã¾ã™ã€‚</p>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€nginxã¯80ç•ªãƒãƒ¼ãƒˆã§HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã†ã‘ã¦ã€<a href="https://127.0.0.1:6443/healthz" target="_blank"><code>https://127.0.0.1:6443/healthz</code></a><code> </code>ã®KubernetesAPIã‚µãƒ¼ãƒãƒ¼ã¸ãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
<aside class="special"><p><code>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã</code>§ã¯ /healthzã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®èªè¨¼ã¯ã„ã‚‰ãªã„ã§ã™ã€‚</p>
</aside>
<p>HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã«nginxã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦èµ·å‹•ã—ã¾ã™ã€‚</p>
<pre>sudo apt-get install -y nginx</pre>
<pre>cat &gt; kubernetes.default.svc.cluster.local &lt;&lt;EOF
server {
  listen      80;
  server_name kubernetes.default.svc.cluster.local;

  location /healthz {
     proxy_pass                    https://127.0.0.1:6443/healthz;
     proxy_ssl_trusted_certificate /var/lib/kubernetes/ca.pem;
  }
}
EOF</pre>
<pre>{
  sudo mv kubernetes.default.svc.cluster.local \
    /etc/nginx/sites-available/kubernetes.default.svc.cluster.local

  sudo ln -s /etc/nginx/sites-available/kubernetes.default.svc.cluster.local /etc/nginx/sites-enabled/
}</pre>
<pre>sudo systemctl restart nginx
sudo systemctl enable nginx</pre>
<h3>ç¢ºèª</h3>
<pre>kubectl get componentstatuses --kubeconfig admin.kubeconfig</pre>
<pre>NAME                 STATUS    MESSAGE              ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-2               Healthy   {&#34;health&#34;: &#34;true&#34;}
etcd-0               Healthy   {&#34;health&#34;: &#34;true&#34;}
etcd-1               Healthy   {&#34;health&#34;: &#34;true&#34;}</pre>
<p>nginxã®HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯proxyã®ãƒã‚§ãƒƒã‚¯</p>
<pre>curl -H &#34;Host: kubernetes.default.svc.cluster.local&#34; -i http://127.0.0.1/healthz</pre>
<pre>HTTP/1.1 200 OK
Server: nginx/1.14.0 (Ubuntu)
Date: Sun, 30 Sep 2018 17:44:24 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 2
Connection: keep-alive

ok</pre>
<aside class="special"><p>å¿µæŠ¼ã—ã§ã™ãŒã€ã“ã“ã¾ã§ã®ã“ã¨ã‚’ã€å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ <code>controller-0</code>ã€<code>controller-1</code>ã€<code>controller-2</code>ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼</p>
</aside>
<h2>kubeletèªå¯ã®RBAC</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Kubernetes APIã‚µãƒ¼ãƒãƒ¼ãŒå„ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã®Kubelet APIã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«RBACã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<p>ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚„ãƒ­ã‚°ã®å–å¾—ã€Podå†…ã§ã®ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã«ã¯ã€Kubelet APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚</p>
<aside class="special"><p>ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Kubelet <code>---authorization-mode</code>ãƒ•ãƒ©ã‚°ã‚’<code>Webhook</code>ã«è¨­å®šã—ã¾ã™ã€‚</p>
<p>Webhookãƒ¢ãƒ¼ãƒ‰<a href="https://kubernetes.io/docs/admin/authorization/#checking-api-access" target="_blank">ã¯ SubjectAccessReview</a> APIã‚’ä½¿ç”¨ã—ã¦èªå¯ã‚’æ±ºå®šã—ã¾ã™</p>
</aside>
<p>ã¾ãšã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚</p>
<pre>gcloud compute ssh controller-0</pre>
<p><code>kube-apiserver-to-kubeletã¨ã„ã†åå‰ã§</code><a href="https://kubernetes.io/docs/admin/authorization/rbac/#role-and-clusterrole" target="_blank">ClusterRole</a>ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<p>ã“ã®ãƒ­ãƒ¼ãƒ«ã«ã€Kubelet APIã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒãƒƒãƒ‰ã®ç®¡ç†ã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &#34;&#34;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - &#34;*&#34;
EOF</pre>
<p>Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã¯ã€ <code>--kubelet-client-certificate</code>ãƒ•ãƒ©ã‚°ã§å®šç¾©ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ä½¿ã£ã¦ã€<code>kubernetes</code>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦Kubeletã«å¯¾ã—ã¦èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚</p>
<p><code>system:kube-apiserver-to-kubelet</code>ã®ClusterRoleã‚’<code>kubernetes</code>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &#34;&#34;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes
EOF</pre>
<h2>Kubernetesã®å‰æ®µã®LB</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã«ãŠãå¤–éƒ¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚</p>
<p><code>kubernetes-the-hard-way</code>ã®é™çš„IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã“ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¾ã™ã€‚</p>
<aside class="special"><p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œæˆã•ã‚Œã‚‹GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†ã§ãã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆã«ä½¿ã£ãŸãƒã‚·ãƒ³ã‹ã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
</aside>
<h3>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°</h3>
<p>å¤–éƒ¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>{
  KUBERNETES_PUBLIC_ADDRESS=$(gcloud compute addresses describe kubernetes-the-hard-way \
    --region $(gcloud config get-value compute/region) \
    --format &#39;value(address)&#39;)

  gcloud compute http-health-checks create kubernetes \
    --description &#34;Kubernetes Health Check&#34; \
    --host &#34;kubernetes.default.svc.cluster.local&#34; \
    --request-path &#34;/healthz&#34;

  gcloud compute firewall-rules create kubernetes-the-hard-way-allow-health-check \
    --network kubernetes-the-hard-way \
    --source-ranges 209.85.152.0/22,209.85.204.0/22,35.191.0.0/16 \
    --allow tcp

  gcloud compute target-pools create kubernetes-target-pool \
    --http-health-check kubernetes

  gcloud compute target-pools add-instances kubernetes-target-pool \
   --instances controller-0,controller-1,controller-2

  gcloud compute forwarding-rules create kubernetes-forwarding-rule \
    --address ${KUBERNETES_PUBLIC_ADDRESS} \
    --ports 6443 \
    --region $(gcloud config get-value compute/region) \
    --target-pool kubernetes-target-pool
}</pre>
<h3>ç¢ºèª</h3>
<p><code>kubernetes-the-hard-way</code>ã®static IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™</p>
<pre>KUBERNETES_PUBLIC_ADDRESS=$(gcloud compute addresses describe kubernetes-the-hard-way \
  --region $(gcloud config get-value compute/region) \
  --format &#39;value(address)&#39;)</pre>
<p>Kubrenetesã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã™ã‚‹HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã—ã¦ã¿ã¾ã™</p>
<pre>curl --cacert ca.pem https://${KUBERNETES_PUBLIC_ADDRESS}:6443/version</pre>
<p>ä¾‹</p>
<pre>{
  &#34;major&#34;: &#34;1&#34;,
  &#34;minor&#34;: &#34;12&#34;,
  &#34;gitVersion&#34;: &#34;v1.12.0&#34;,
  &#34;gitCommit&#34;: &#34;0ed33881dc4355495f623c6f22e7dd0b7632b7c0&#34;,
  &#34;gitTreeState&#34;: &#34;clean&#34;,
  &#34;buildDate&#34;: &#34;2018-09-27T16:55:41Z&#34;,
  &#34;goVersion&#34;: &#34;go1.10.4&#34;,
  &#34;compiler&#34;: &#34;gc&#34;,
  &#34;platform&#34;: &#34;linux/amd64&#34;
}</pre>


      </google-codelab-step>
    
      <google-codelab-step label="09. Kubernetesã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã‚’ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã™ã‚‹" duration="0">
        <p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€3ã¤ã®Kubernetesãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã‚’ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
<p>ä¸‹è¨˜ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å„ãƒãƒ¼ãƒ‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>
<p><a href="https://github.com/opencontainers/runc" target="_blank">runc</a>ã€<a href="https://github.com/google/gvisor" target="_blank">gVisor</a>ã€<a href="https://github.com/containernetworking/cni" target="_blank">container networking plugin</a>ã€<a href="https://github.com/containerd/containerd" target="_blank">containerd</a>ã€<a href="https://kubernetes.io/docs/admin/kubelet" target="_blank">kubelet</a>ã€<a href="https://kubernetes.io/docs/concepts/cluster-administration/proxies" target="_blank">kube-proxy</a></p>
<h2>æº–å‚™</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€<code>worker-0</code>ã€<code>worker-1</code>ã€<code>worker-2</code>ã®å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>gcloudã‚³ãƒãƒ³ãƒ‰çµŒç”±ã§å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
<pre>gcloud compute ssh worker-0</pre>
<h3>tmuxã‚’ä½¿ã£ã¦ä¸¦åˆ—ã«ã‚³ãƒãƒ³ãƒ‰ã‚’èµ°ã‚‰ã›ã‚‹</h3>
<p>tmuxã‚’ä½¿ãˆã°ã€åŒæ™‚ã«è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒã§ãã¾ã™ã€‚</p>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/01-prerequisites.md#running-commands-in-parallel-with-tmux" target="_blank">ã“ã£ã¡</a>ã‚’ã¿ã¦ã¿ã¦ã­ã€‚</p>
<h2>Kubernetesã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ³ã‚°</h2>
<p>ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>
<pre>{
  sudo apt-get update
  sudo apt-get -y install socat conntrack ipset
}</pre>
<aside class="special"><p>socatã¯<code>kubectl port-forward</code>ã‚³ãƒãƒ³ãƒ‰ã«å¿…è¦ã¨ãªã‚Šã¾ã™ã€‚</p>
</aside>
<h3>ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒã‚¤ãƒŠãƒªã‚’DLã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
<pre>wget -q --show-progress --https-only --timestamping \
  https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.12.0/crictl-v1.12.0-linux-amd64.tar.gz \
  https://storage.googleapis.com/kubernetes-the-hard-way/runsc-50c283b9f56bb7200938d9e207355f05f79f0d17 \
  https://github.com/opencontainers/runc/releases/download/v1.0.0-rc5/runc.amd64 \
  https://github.com/containernetworking/plugins/releases/download/v0.6.0/cni-plugins-amd64-v0.6.0.tgz \
  https://github.com/containerd/containerd/releases/download/v1.2.0-rc.0/containerd-1.2.0-rc.0.linux-amd64.tar.gz \
  https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kubectl \
  https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kube-proxy \
  https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kubelet</pre>
<p>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>sudo mkdir -p \
  /etc/cni/net.d \
  /opt/cni/bin \
  /var/lib/kubelet \
  /var/lib/kube-proxy \
  /var/lib/kubernetes \
  /var/run/kubernetes</pre>
<p>ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒã‚¤ãƒŠãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>
<pre>{
  sudo mv runsc-50c283b9f56bb7200938d9e207355f05f79f0d17 runsc
  sudo mv runc.amd64 runc
  chmod +x kubectl kube-proxy kubelet runc runsc
  sudo mv kubectl kube-proxy kubelet runc runsc /usr/local/bin/
  sudo tar -xvf crictl-v1.12.0-linux-amd64.tar.gz -C /usr/local/bin/
  sudo tar -xvf cni-plugins-amd64-v0.6.0.tgz -C /opt/cni/bin/
  sudo tar -xvf containerd-1.2.0-rc.0.linux-amd64.tar.gz -C /
}</pre>
<h3>CNIãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã®è¨­å®š</h3>
<p>ç¾åœ¨ã®GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®Podã®CIDRç¯„å›²ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>POD_CIDR=$(curl -s -H &#34;Metadata-Flavor: Google&#34; \
  http://metadata.google.internal/computeMetadata/v1/instance/attributes/pod-cidr)</pre>
<p><code>bridge</code>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/cni/net.d/10-bridge.conf
{
    &#34;cniVersion&#34;: &#34;0.3.1&#34;,
    &#34;name&#34;: &#34;bridge&#34;,
    &#34;type&#34;: &#34;bridge&#34;,
    &#34;bridge&#34;: &#34;cnio0&#34;,
    &#34;isGateway&#34;: true,
    &#34;ipMasq&#34;: true,
    &#34;ipam&#34;: {
        &#34;type&#34;: &#34;host-local&#34;,
        &#34;ranges&#34;: [
          [{&#34;subnet&#34;: &#34;${POD_CIDR}&#34;}]
        ],
        &#34;routes&#34;: [{&#34;dst&#34;: &#34;0.0.0.0/0&#34;}]
    }
}
EOF</pre>
<p><code>loopback</code>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/cni/net.d/99-loopback.conf
{
    &#34;cniVersion&#34;: &#34;0.3.1&#34;,
    &#34;type&#34;: &#34;loopback&#34;
}
EOF</pre>
<h3>containerdã®è¨­å®š</h3>
<p><code>containerd</code>ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>sudo mkdir -p /etc/containerd/</pre>
<pre>cat &lt;&lt; EOF | sudo tee /etc/containerd/config.toml
[plugins]
  [plugins.cri.containerd]
    snapshotter = &#34;overlayfs&#34;
    [plugins.cri.containerd.default_runtime]
      runtime_type = &#34;io.containerd.runtime.v1.linux&#34;
      runtime_engine = &#34;/usr/local/bin/runc&#34;
      runtime_root = &#34;&#34;
    [plugins.cri.containerd.untrusted_workload_runtime]
      runtime_type = &#34;io.containerd.runtime.v1.linux&#34;
      runtime_engine = &#34;/usr/local/bin/runsc&#34;
      runtime_root = &#34;/run/containerd/runsc&#34;
    [plugins.cri.containerd.gvisor]
      runtime_type = &#34;io.containerd.runtime.v1.linux&#34;
      runtime_engine = &#34;/usr/local/bin/runsc&#34;
      runtime_root = &#34;/run/containerd/runsc&#34;
EOF</pre>
<aside class="special"><p>ä¿¡é ¼ã§ããªã„ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã¯gVisor(runsc)ãŒä½¿ã‚ã‚Œã¾ã™</p>
</aside>
<p><code>containerd.service</code> systemdã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/containerd.service
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target

[Service]
ExecStartPre=/sbin/modprobe overlay
ExecStart=/bin/containerd
Restart=always
RestartSec=5
Delegate=yes
KillMode=process
OOMScoreAdjust=-999
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity

[Install]
WantedBy=multi-user.target
EOF</pre>
<h3>Kubeletã®è¨­å®š</h3>
<pre>{
  sudo mv ${HOSTNAME}-key.pem ${HOSTNAME}.pem /var/lib/kubelet/
  sudo mv ${HOSTNAME}.kubeconfig /var/lib/kubelet/kubeconfig
  sudo mv ca.pem /var/lib/kubernetes/
}</pre>
<p><code>kubelet-config.yaml</code> è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: &#34;/var/lib/kubernetes/ca.pem&#34;
authorization:
  mode: Webhook
clusterDomain: &#34;cluster.local&#34;
clusterDNS:
  - &#34;10.32.0.10&#34;
podCIDR: &#34;${POD_CIDR}&#34;
resolvConf: &#34;/run/systemd/resolve/resolv.conf&#34;
runtimeRequestTimeout: &#34;15m&#34;
tlsCertFile: &#34;/var/lib/kubelet/${HOSTNAME}.pem&#34;
tlsPrivateKeyFile: &#34;/var/lib/kubelet/${HOSTNAME}-key.pem&#34;
EOF</pre>
<aside class="special"><p>resolvConfã®è¨­å®šã¯ã€<code>systemd-resolved</code>ãŒèµ°ã£ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã«CoreDNSã‚’ä½¿ã†éš›ã«ãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‹ãŸã‚ã®è¨­å®šã«ãªã‚Šã¾ã™ã€‚</p>
</aside>
<p><code>kubelet.service</code> systemdãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=containerd.service
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
  --config=/var/lib/kubelet/kubelet-config.yaml \\
  --container-runtime=remote \\
  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\
  --image-pull-progress-deadline=2m \\
  --kubeconfig=/var/lib/kubelet/kubeconfig \\
  --network-plugin=cni \\
  --register-node=true \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</pre>
<h3>Kubernetes Proxyã®è¨­å®š</h3>
<pre>sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig</pre>
<p><code>kube-proxy-config.yaml</code> è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
clientConnection:
  kubeconfig: &#34;/var/lib/kube-proxy/kubeconfig&#34;
mode: &#34;iptables&#34;
clusterCIDR: &#34;10.200.0.0/16&#34;
EOF</pre>
<p><code>kube-proxy.service</code> systemdãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/var/lib/kube-proxy/kube-proxy-config.yaml
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</pre>
<h3>ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã®èµ·å‹•</h3>
<pre>{
  sudo systemctl daemon-reload
  sudo systemctl enable containerd kubelet kube-proxy
  sudo systemctl start containerd kubelet kube-proxy
}</pre>
<aside class="special"><p>å¿µæŠ¼ã—ã§ã™ãŒã€ã“ã“ã¾ã§ã®ã“ã¨ã‚’ã€å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã€<code>worker-0</code>ã€<code>worker-1</code>ã€<code>worker-2</code>ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼</p>
</aside>
<h2>ç¢ºèª</h2>
<aside class="special"><p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ä½œæˆã•ã‚Œã‚‹GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†ã§ãã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆã«ä½¿ã£ãŸãƒã‚·ãƒ³ã‹ã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
</aside>
<p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹Kubernetesãƒãƒ¼ãƒ‰ã®ä¸€è¦§ã‚’è¡¨ç¤ºã•ã›ã¾ã™ã€‚</p>
<pre>gcloud compute ssh controller-0 \
  --command &#34;kubectl get nodes --kubeconfig admin.kubeconfig&#34;</pre>
<p>ä¾‹</p>
<pre>NAME       STATUS   ROLES    AGE   VERSION
worker-0   Ready    &lt;none&gt;   35s   v1.12.0
worker-1   Ready    &lt;none&gt;   36s   v1.12.0
worker-2   Ready    &lt;none&gt;   36s   v1.12.0</pre>


      </google-codelab-step>
    
      <google-codelab-step label="10. å¤–éƒ¨ã‹ã‚‰ã®kubectlã‚’å©ããŸã‚ã®è¨­å®š" duration="0">
        <p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€<code>admin</code>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®credenialã«åŸºã¥ã„ãŸã€<code>kubectl</code>ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç”¨ã®kubeconfigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<aside class="special"><p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€adminã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã®ç”Ÿæˆã«ä½¿ç”¨ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
</aside>
<h2>Admin Kubernetesè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</h2>
<p>å„kubeconfigã¯ã€Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã¨æ¥ç¶šã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>é«˜å¯ç”¨æ€§ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã«ã‚ã‚‹å¤–éƒ¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p>adminãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè¨¼ã™ã‚‹ã®ã«é©ã—ãŸkubeconfigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
<pre>{
  KUBERNETES_PUBLIC_ADDRESS=$(gcloud compute addresses describe kubernetes-the-hard-way \
    --region $(gcloud config get-value compute/region) \
    --format &#39;value(address)&#39;)

  kubectl config set-cluster kubernetes-the-hard-way \
    --certificate-authority=ca.pem \
    --embed-certs=true \
    --server=https://${KUBERNETES_PUBLIC_ADDRESS}:6443

  kubectl config set-credentials admin \
    --client-certificate=admin.pem \
    --client-key=admin-key.pem

  kubectl config set-context kubernetes-the-hard-way \
    --cluster=kubernetes-the-hard-way \
    --user=admin

  kubectl config use-context kubernetes-the-hard-way
}</pre>
<h2>ç¢ºèª</h2>
<p>remoteã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre>kubectl get componentstatuses</pre>
<p>ä¾‹</p>
<pre>NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-1               Healthy   {&#34;health&#34;:&#34;true&#34;}
etcd-2               Healthy   {&#34;health&#34;:&#34;true&#34;}
etcd-0               Healthy   {&#34;health&#34;:&#34;true&#34;}</pre>
<p>remoteã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ãƒãƒ¼ãƒ‰ã®ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>kubectl get nodes</pre>
<p>ä¾‹</p>
<pre>NAME       STATUS   ROLES    AGE    VERSION
worker-0   Ready    &lt;none&gt;   117s   v1.12.0
worker-1   Ready    &lt;none&gt;   118s   v1.12.0
worker-2   Ready    &lt;none&gt;   118s   v1.12.0</pre>
<p>11. Podã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒˆã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°</p>
<p>ãƒãƒ¼ãƒ‰ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸPodã¯ã€ãƒãƒ¼ãƒ‰ã®Podã®CIDRç¯„å›²ã‹ã‚‰IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚</p>
<p>ã“ã®æ™‚ç‚¹ã§ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯<a href="https://cloud.google.com/compute/docs/vpc/routes" target="_blank">ãƒ«ãƒ¼ãƒˆ</a>ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€Podã¯ç•°ãªã‚‹ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ä»–ã®Podã¨é€šä¿¡ã§ãã¾ã›ã‚“ã€‚</p>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€ãƒãƒ¼ãƒ‰ã®Pod CIDRç¯„å›²ã‚’ãƒãƒ¼ãƒ‰ã®å†…éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ã€å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã®ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<aside class="special"><p>Kubernetesã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ã¯<a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-achieve-this" target="_blank">ä»–ã«ã‚‚</a>ã‚ã‚Šã¾ã™ã€‚</p>
</aside>
<h2>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«</h2>
<p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€<code>kubernetes-the-hard-way</code> VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ã‚’é›†ã‚ã¾ã™ã€‚</p>
<p>å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†…éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨Pod CIDRç¯„å›²ã‚’è¡¨ç¤ºã•ã›ã¾ã™ã€‚</p>
<pre>for instance in worker-0 worker-1 worker-2; do
  gcloud compute instances describe ${instance} \
    --format &#39;value[separator=&#34; &#34;](networkInterfaces[0].networkIP,metadata.items[0].value)&#39;
done</pre>
<p>ä¾‹</p>
<pre>10.240.0.20 10.200.0.0/24
10.240.0.21 10.200.1.0/24
10.240.0.22 10.200.2.0/24</pre>
<h2>ãƒ«ãƒ¼ãƒˆç¾¤</h2>
<p>å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<pre>for i in 0 1 2; do
  gcloud compute routes create kubernetes-route-10-200-${i}-0-24 \
    --network kubernetes-the-hard-way \
    --next-hop-address 10.240.0.2${i} \
    --destination-range 10.200.${i}.0/24
done</pre>
<p><code>kubernetes-the-hard-way</code>ã®VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä¸­ã®ãƒ«ãƒ¼ãƒˆã®ä¸€è¦§ã‚’å‡ºã—ã¾ã™ã€‚</p>
<pre>gcloud compute routes list --filter &#34;network: kubernetes-the-hard-way&#34;</pre>
<p>ä¾‹</p>
<pre>NAME                            NETWORK                  DEST_RANGE     NEXT_HOP                  PRIORITY
default-route-081879136902de56  kubernetes-the-hard-way  10.240.0.0/24  kubernetes-the-hard-way   1000
default-route-55199a5aa126d7aa  kubernetes-the-hard-way  0.0.0.0/0      default-internet-gateway  1000
kubernetes-route-10-200-0-0-24  kubernetes-the-hard-way  10.200.0.0/24  10.240.0.20               1000
kubernetes-route-10-200-1-0-24  kubernetes-the-hard-way  10.200.1.0/24  10.240.0.21               1000
kubernetes-route-10-200-2-0-24  kubernetes-the-hard-way  10.200.2.0/24  10.240.0.22               1000</pre>


      </google-codelab-step>
    
      <google-codelab-step label="12. DNSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¢ãƒ‰ã‚ªãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤" duration="0">
        <p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã§å‹•ã„ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã€<a href="https://coredns.io/" target="_blank">CoreDNS</a>ã‚’ä½¿ã£ãŸDNSãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã‚’æä¾›ã™ã‚‹<a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank">DNSã‚¢ãƒ‰ã‚ªãƒ³</a>ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<h2>DNSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¢ãƒ‰ã‚ªãƒ³</h2>
<p><code>coredns</code>ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¢ãƒ‰ã‚ªãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<pre>kubectl apply -f https://storage.googleapis.com/kubernetes-the-hard-way/coredns.yaml</pre>
<p>output</p>
<pre>serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.extensions/coredns created
service/kube-dns created</pre>
<p>kube-dns deploymentã«ã‚ˆã£ã¦ä½œã‚‰ã‚ŒãŸPodã®ç¢ºèª</p>
<pre>kubectl get pods -l k8s-app=kube-dns -n kube-system</pre>
<p>output</p>
<pre>NAME                       READY   STATUS    RESTARTS   AGE
coredns-699f8ddd77-94qv9   1/1     Running   0          20s
coredns-699f8ddd77-gtcgb   1/1     Running   0          20s</pre>
<h2>ç¢ºèª</h2>
<p><code>busybox</code> deploymentã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>kubectl run busybox --image=busybox:1.28 --command -- sleep 3600</pre>
<p><code>busybox</code> deploymentã«ã‚ˆã£ã¦ä½œã‚‰ã‚Œã¦Podã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre>kubectl get pods -l run=busybox</pre>
<p>output</p>
<pre>NAME                      READY   STATUS    RESTARTS   AGE
busybox-bd8fb7cbd-vflm9   1/1     Running   0          10s</pre>
<p><code>busybox</code> Podã®ãƒ•ãƒ«ãƒãƒ¼ãƒ ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>POD_NAME=$(kubectl get pods -l run=busybox -o jsonpath=&#34;{.items[0].metadata.name}&#34;)</pre>
<p><code>busybox</code> Podã®ä¸­ã‹ã‚‰<code>kubernetes</code> serviceã®DNS lookupã‚’è¡Œã„ã¾ã™ã€‚</p>
<pre>kubectl exec -ti $POD_NAME -- nslookup kubernetes</pre>
<p>output</p>
<pre>Server:    10.32.0.10
Address 1: 10.32.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address 1: 10.32.0.1 kubernetes.default.svc.cluster.local</pre>


      </google-codelab-step>
    
      <google-codelab-step label="13. ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ" duration="0">
        <p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<h2>ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯<a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#verifying-that-data-is-encrypted" target="_blank">ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–</a>ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p>generic secretã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>kubectl create secret generic kubernetes-the-hard-way \
  --from-literal=&#34;mykey=mydata&#34;</pre>
<p>etcdã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹<code>kubernetes-the-hard-way</code> secretã‚’hexdumpã—ã¾ã™ã€‚</p>
<pre>gcloud compute ssh controller-0 \
  --command &#34;sudo ETCDCTL_API=3 etcdctl get \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/etcd/ca.pem \
  --cert=/etc/etcd/kubernetes.pem \
  --key=/etc/etcd/kubernetes-key.pem\
  /registry/secrets/default/kubernetes-the-hard-way | hexdump -C&#34;</pre>
<p>output</p>
<pre>00000000  2f 72 65 67 69 73 74 72  79 2f 73 65 63 72 65 74  |/registry/secret|
00000010  73 2f 64 65 66 61 75 6c  74 2f 6b 75 62 65 72 6e  |s/default/kubern|
00000020  65 74 65 73 2d 74 68 65  2d 68 61 72 64 2d 77 61  |etes-the-hard-wa|
00000030  79 0a 6b 38 73 3a 65 6e  63 3a 61 65 73 63 62 63  |y.k8s:enc:aescbc|
00000040  3a 76 31 3a 6b 65 79 31  3a dd 3f 36 6c ce 65 9d  |:v1:key1:.?6l.e.|
00000050  b3 b1 46 1a ba ae a2 1f  e4 fa 13 0c 4b 6e 2c 3c  |..F.........Kn,&lt;|
00000060  15 fa 88 56 84 b7 aa c0  7a ca 66 f3 de db 2b a3  |...V....z.f...+.|
00000070  88 dc b1 b1 d8 2f 16 3e  6b 4a cb ac 88 5d 23 2d  |...../.&gt;kJ...]#-|
00000080  99 62 be 72 9f a5 01 38  15 c4 43 ac 38 5f ef 88  |.b.r...8..C.8_..|
00000090  3b 88 c1 e6 b6 06 4f ae  a8 6b c8 40 70 ac 0a d3  |;.....O..k.@p...|
000000a0  3e dc 2b b6 0f 01 b6 8b  e2 21 29 4d 32 d6 67 a6  |&gt;.+......!)M2.g.|
000000b0  4e 6d bb 61 0d 85 22 ea  f4 d6 2d 0a af 3c 71 85  |Nm.a..&#34;...-..&lt;q.|
000000c0  96 27 c9 ec 90 e3 56 8c  94 a7 1c 9a 0e 00 28 11  |.&#39;....V.......(.|
000000d0  18 28 f4 33 42 d9 57 d9  e3 e9 1c 38 e3 bc 1e c3  |.(.3B.W....8....|
000000e0  d2 47 f3 20 60 be b8 57  a7 0a                    |.G. `..W..|
000000ea</pre>
<p>etcdã‚­ãƒ¼ã¯ã€<code>k8s:enc:aescbc:v1:key1</code>ã¨ã„ã†ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚</p>
<p>ã“ã‚Œã¯ã€<code>aescbc</code>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãŒ<code>key1ã</code>¨ã„ã†æš—å·åŒ–ã‚­ãƒ¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã—ãŸã“ã¨ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚</p>
<h2>Deployment</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank">Deployment</a>ã®ä½œæˆã¨ç®¡ç†ãŒã§ãã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p><a href="https://nginx.org/en/" target="_blank">nginx</a> web serverã®deploymentã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<pre>kubectl run nginx --image=nginx</pre>
<p><code>nginx</code> deploymentã«ã‚ˆã£ã¦ã§ããŸPodã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre>kubectl get pods -l run=nginx</pre>
<p>output</p>
<pre>NAME                    READY   STATUS    RESTARTS   AGE
nginx-dbddb74b8-6lxg2   1/1     Running   0          10s</pre>
<h3>Port Forwading</h3>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€<a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/" target="_blank">port forwading</a>ã‚’ä½¿ã£ã¦å¤–éƒ¨ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p><code>nginx</code> podã®ãƒ•ãƒ«ãƒãƒ¼ãƒ ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>POD_NAME=$(kubectl get pods -l run=nginx -o jsonpath=&#34;{.items[0].metadata.name}&#34;)</pre>
<p>ãƒ­ãƒ¼ã‚«ãƒ«ã®<code>8080</code>ãƒãƒ¼ãƒˆã‚’<code>nginx</code> Podã®<code>80</code>ç•ªãƒãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
<pre>kubectl port-forward $POD_NAME 8080:80</pre>
<p>output</p>
<pre>Forwarding from 127.0.0.1:8080 -&gt; 80
Forwarding from [::1]:8080 -&gt; 80</pre>
<p>åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚</p>
<pre>curl --head http://127.0.0.1:8080</pre>
<p>output</p>
<pre>HTTP/1.1 200 OK
Server: nginx/1.15.4
Date: Sun, 30 Sep 2018 19:23:10 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 25 Sep 2018 15:04:03 GMT
Connection: keep-alive
ETag: &#34;5baa4e63-264&#34;
Accept-Ranges: bytes</pre>
<p>ã‚‚ã¨ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æˆ»ã£ã¦<code>nginx</code> Podã¸ã®ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ­¢ã‚ã¾ã™ã€‚</p>
<pre>Forwarding from 127.0.0.1:8080 -&gt; 80
Forwarding from [::1]:8080 -&gt; 80
Handling connection for 8080
^C</pre>
<h3>Logs</h3>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€<a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/" target="_blank">ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã®å–å¾—</a>ãŒã§ãã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p><code>nginx</code> Podã®ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
<pre>kubectl logs $POD_NAME</pre>
<p>output</p>
<pre>127.0.0.1 - - [30/Sep/2018:19:23:10 +0000] &#34;HEAD / HTTP/1.1&#34; 200 0 &#34;-&#34; &#34;curl/7.58.0&#34; &#34;-&#34;</pre>
<h3>Exec</h3>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/#running-individual-commands-in-a-container" target="_blank">ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ</a>ãŒã§ãã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p><code>nginx</code>ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ã¦ã€<code>nginx -v</code>ã‚’å®Ÿè¡Œã—ã¦nginxã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
<pre>kubectl exec -ti $POD_NAME -- nginx -v</pre>
<p>output</p>
<pre>nginx version: nginx/1.15.4</pre>
<h2>Services</h2>
<p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€<a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank">Service</a>ã‚’ä½¿ã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¬é–‹ãŒã§ãã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p><code>nginx</code> deploymentã‚’<a href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport" target="_blank">NodePort</a>ã‚’ä½¿ã£ã¦å…¬é–‹ã—ã¾ã™ã€‚</p>
<pre>kubectl expose deployment nginx --port 80 --type NodePort</pre>
<aside class="special"><p>ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒ<a href="https://kubernetes.io/docs/getting-started-guides/scratch/#cloud-provider" target="_blank">ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</a>ã®è¨­å®šãŒã•ã‚Œã¦ã„ãªã„ãŸã‚ã€LoadBalancerã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
<p>ã“ã®ãƒ©ãƒœã§ã¯ã€<a href="https://kubernetes.io/docs/getting-started-guides/scratch/#cloud-provider" target="_blank">ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</a>ã®è¨­å®šã¯å¯¾è±¡å¤–ã§ã™ã€‚</p>
</aside>
<p><code>nginx</code> serviceã§ã‚¢ã‚µã‚¤ãƒ³ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã®ãƒãƒ¼ãƒˆå–å¾—ã—ã¾ã™ã€‚</p>
<pre>NODE_PORT=$(kubectl get svc nginx \
  --output=jsonpath=&#39;{range .spec.ports[0]}{.nodePort}&#39;)</pre>
<p><code>nginx</code>ãƒãƒ¼ãƒ‰ãƒãƒ¼ãƒˆã«å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã‚¦ã‚©ãƒ¼ãƒ«ã®ãƒ«ãƒ¼ãƒ«è¿½åŠ ã—ã¾ã™ã€‚</p>
<pre>gcloud compute firewall-rules create kubernetes-the-hard-way-allow-nginx-service \
  --allow=tcp:${NODE_PORT} \
  --network kubernetes-the-hard-way</pre>
<p>ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰å¤–éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>EXTERNAL_IP=$(gcloud compute instances describe worker-0 \
  --format &#39;value(networkInterfaces[0].accessConfigs[0].natIP)&#39;)</pre>
<p>å¤–éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨<code>nginx</code>ãƒãƒ¼ãƒ‰ãƒãƒ¼ãƒˆçµ„ã‚ã›ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚</p>
<pre>curl -I http://${EXTERNAL_IP}:${NODE_PORT}</pre>
<p>output</p>
<pre>HTTP/1.1 200 OK
Server: nginx/1.15.4
Date: Sun, 30 Sep 2018 19:25:40 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 25 Sep 2018 15:04:03 GMT
Connection: keep-alive
ETag: &#34;5baa4e63-264&#34;
Accept-Ranges: bytes</pre>
<h2>Untrusted Workloads</h2>
<p><a href="https://github.com/google/gvisor" target="_blank">gVisor</a>ã‚’ä½¿ã£ã¦ä¿¡é ¼ã•ã‚Œã¦ã„ãªã„ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ãŒå‹•ã‹ã›ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p><code>untrusted</code>Podã‚’ä½œã‚Šã¾ã™ã€‚</p>
<pre>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: untrusted
  annotations:
    io.kubernetes.cri.untrusted-workload: &#34;true&#34;
spec:
  containers:
    - name: webserver
      image: gcr.io/hightowerlabs/helloworld:2.0.0
EOF</pre>
<h3>ç¢ºèª</h3>
<p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã‚’èª¿ã¹ã¦ã€<code>untrusted</code>PodãŒgVisor(runsc)ã®ä¸‹ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<p><code>untrusted</code>PodãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre>kubectl get pods -o wide</pre>
<pre>NAME                       READY     STATUS    RESTARTS   AGE       IP           NODE
busybox-68654f944b-djjjb   1/1       Running   0          5m        10.200.0.2   worker-0
nginx-65899c769f-xkfcn     1/1       Running   0          4m        10.200.1.2   worker-1
untrusted                  1/1       Running   0          10s       10.200.0.3   worker-0</pre>
<p><code>untrusted</code>PodãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã®åå‰ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>INSTANCE_NAME=$(kubectl get pod untrusted --output=jsonpath=&#39;{.spec.nodeName}&#39;)</pre>
<p>ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã®sshã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚</p>
<pre>gcloud compute ssh ${INSTANCE_NAME}</pre>
<p>gVisorã®ã‚‚ã¨ã§å‹•ã„ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>sudo runsc --root  /run/containerd/runsc/k8s.io list</pre>
<pre>I0930 19:27:13.255142   20832 x:0] ***************************
I0930 19:27:13.255326   20832 x:0] Args: [runsc --root /run/containerd/runsc/k8s.io list]
I0930 19:27:13.255386   20832 x:0] Git Revision: 50c283b9f56bb7200938d9e207355f05f79f0d17
I0930 19:27:13.255429   20832 x:0] PID: 20832
I0930 19:27:13.255472   20832 x:0] UID: 0, GID: 0
I0930 19:27:13.255591   20832 x:0] Configuration:
I0930 19:27:13.255654   20832 x:0]              RootDir: /run/containerd/runsc/k8s.io
I0930 19:27:13.255781   20832 x:0]              Platform: ptrace
I0930 19:27:13.255893   20832 x:0]              FileAccess: exclusive, overlay: false
I0930 19:27:13.256004   20832 x:0]              Network: sandbox, logging: false
I0930 19:27:13.256128   20832 x:0]              Strace: false, max size: 1024, syscalls: []
I0930 19:27:13.256238   20832 x:0] ***************************
ID                                                                 PID         STATUS      BUNDLE                                                                                                                   CREATED                OWNER
79e74d0cec52a1ff4bc2c9b0bb9662f73ea918959c08bca5bcf07ddb6cb0e1fd   20449       running     /run/containerd/io.containerd.runtime.v1.linux/k8s.io/79e74d0cec52a1ff4bc2c9b0bb9662f73ea918959c08bca5bcf07ddb6cb0e1fd   0001-01-01T00:00:00Z
af7470029008a4520b5db9fb5b358c65d64c9f748fae050afb6eaf014a59fea5   20510       running     /run/containerd/io.containerd.runtime.v1.linux/k8s.io/af7470029008a4520b5db9fb5b358c65d64c9f748fae050afb6eaf014a59fea5   0001-01-01T00:00:00Z
I0930 19:27:13.259733   20832 x:0] Exiting with status: 0</pre>
<p><code>untrusted</code>Podã®IDã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>POD_ID=$(sudo crictl -r unix:///var/run/containerd/containerd.sock \
  pods --name untrusted -q)</pre>
<p><code>untrusted</code>Podã®ä¸­ã§å‹•ã„ã¦ã‚‹<code>webserver</code>ã‚³ãƒ³ãƒ†ãƒŠã®IDã‚’å–å¾—ã—ã¾ã™ã€‚</p>
<pre>CONTAINER_ID=$(sudo crictl -r unix:///var/run/containerd/containerd.sock \
  ps -p ${POD_ID} -q)</pre>
<p>gVisorã®<code>runsc</code>ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã€<code>webserver</code>ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã§èµ°ã£ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
<pre>sudo runsc --root /run/containerd/runsc/k8s.io ps ${CONTAINER_ID}</pre>
<p>output</p>
<pre>I0930 19:31:31.419765   21217 x:0] ***************************
I0930 19:31:31.419907   21217 x:0] Args: [runsc --root /run/containerd/runsc/k8s.io ps af7470029008a4520b5db9fb5b358c65d64c9f748fae050afb6eaf014a59fea5]
I0930 19:31:31.419959   21217 x:0] Git Revision: 50c283b9f56bb7200938d9e207355f05f79f0d17
I0930 19:31:31.420000   21217 x:0] PID: 21217
I0930 19:31:31.420041   21217 x:0] UID: 0, GID: 0
I0930 19:31:31.420081   21217 x:0] Configuration:
I0930 19:31:31.420115   21217 x:0]              RootDir: /run/containerd/runsc/k8s.io
I0930 19:31:31.420188   21217 x:0]              Platform: ptrace
I0930 19:31:31.420266   21217 x:0]              FileAccess: exclusive, overlay: false
I0930 19:31:31.420424   21217 x:0]              Network: sandbox, logging: false
I0930 19:31:31.420515   21217 x:0]              Strace: false, max size: 1024, syscalls: []
I0930 19:31:31.420676   21217 x:0] ***************************
UID       PID       PPID      C         STIME     TIME      CMD
0         1         0         0         19:26     10ms      app
I0930 19:31:31.422022   21217 x:0] Exiting with status: 0</pre>


      </google-codelab-step>
    
      <google-codelab-step label="14. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—" duration="0">
        <p>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€ä»Šã¾ã§ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œã£ã¦ããŸãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
<h2>GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</h2>
<p>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è½ã¨ã—ã¾ã™ã€‚</p>
<pre>gcloud -q compute instances delete \
  controller-0 controller-1 controller-2 \
  worker-0 worker-1 worker-2</pre>
<h2>Networking</h2>
<p>å¤–éƒ¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
<pre>{
  gcloud -q compute forwarding-rules delete kubernetes-forwarding-rule \
    --region $(gcloud config get-value compute/region)

  gcloud -q compute target-pools delete kubernetes-target-pool

  gcloud -q compute http-health-checks delete kubernetes

  gcloud -q compute addresses delete kubernetes-the-hard-way
}</pre>
<p><code>kubernetes-the-hard-way</code>ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
<pre>gcloud -q compute firewall-rules delete \
  kubernetes-the-hard-way-allow-nginx-service \
  kubernetes-the-hard-way-allow-internal \
  kubernetes-the-hard-way-allow-external \
  kubernetes-the-hard-way-allow-health-check</pre>
<p><code>kubernetes-the-hard-way</code>VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
<pre>{
  gcloud -q compute routes delete \
    kubernetes-route-10-200-0-0-24 \
    kubernetes-route-10-200-1-0-24 \
    kubernetes-route-10-200-2-0-24

  gcloud -q compute networks subnets delete kubernetes

  gcloud -q compute networks delete kubernetes-the-hard-way
}</pre>
<p>ä»¥ä¸Šã§å®Œäº†ã§ã™ï¼</p>
<p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</p>


      </google-codelab-step>
    
  </google-codelab>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49880327-14', 'auto');

    (function() {
      var gaCodelab = '';
      if (gaCodelab) {
        ga('create', gaCodelab, 'auto', {name: 'codelab'});
      }

      var gaView;
      var parts = location.search.substring(1).split('&');
      for (var i = 0; i < parts.length; i++) {
        var param = parts[i].split('=');
        if (param[0] === 'viewga') {
          gaView = param[1];
          break;
        }
      }
      if (gaView && gaView !== gaCodelab) {
        ga('create', gaView, 'auto', {name: 'view'});
      }
    })();
  </script>

</body>
</html>
